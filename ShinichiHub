-- 🌟 Load Config từ Loadstring
local Config = getgenv() and getgenv().ShinichiConfig or {
    CollectChest = true,
    EspChest = true,
    TeamJoin = "Pirates",
    StopWhenGotRareItem = true,
    ScanRadius = 1000,
    TweenSpeed = 50,
    ServerHopWhenEmpty = true
}

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")

-- 🌟 Auto Chọn Team
if Config.TeamJoin then
    spawn(function()
        local Team = Config.TeamJoin == "Pirates" and "Pirates" or "Marines"
        ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", Team)
        wait(3) -- Chờ game load tránh lỗi
    end)
end

-- 🌟 ESP Chest
if Config.EspChest then
    spawn(function()
        while wait(1) do
            for _, chest in pairs(Workspace:GetChildren()) do
                if chest:IsA("Model") and string.find(chest.Name, "Chest") then
                    if not chest:FindFirstChild("NameEsp") then
                        local Esp = Instance.new("BillboardGui", chest)
                        Esp.Name = "NameEsp"
                        Esp.Size = UDim2.new(1, 200, 1, 30)
                        Esp.Adornee = chest
                        Esp.AlwaysOnTop = true
                        local Label = Instance.new("TextLabel", Esp)
                        Label.Text = chest.Name
                        Label.TextColor3 = Color3.new(1, 1, 1)
                        Label.BackgroundTransparency = 1
                        Label.Size = UDim2.new(1, 0, 1, 0)
                    end
                end
            end
        end
    end)
end

-- 🌟 Auto Collect Chest
if Config.CollectChest then
    spawn(function()
        while wait() do
            local Chests = {}
            for _, v in pairs(Workspace:GetChildren()) do
                if v:IsA("Model") and string.find(v.Name, "Chest") then
                    table.insert(Chests, v)
                end
            end

            if #Chests > 0 then
                local ClosestChest = nil
                local ClosestDist = math.huge
                for _, chest in pairs(Chests) do
                    local Dist = (LocalPlayer.Character.HumanoidRootPart.Position - chest:GetPivot().Position).Magnitude
                    if Dist < ClosestDist then
                        ClosestDist = Dist
                        ClosestChest = chest
                    end
                end

                if ClosestChest then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = ClosestChest:GetPivot()
                    wait(1)
                end
            else
                -- Kiểm tra item quan trọng trước khi đổi server
                local hasImportantItem = false
                for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
                    if (Config.StopWhenGotRareItem and (item.Name == "God's Chalice" or item.Name == "Fist of Darkness")) then
                        hasImportantItem = true
                        break
                    end
                end

                -- Chỉ hop server nếu hết rương và không có item quan trọng
                if Config.ServerHopWhenEmpty and not hasImportantItem then
                    wait(5)
                    TeleportService:Teleport(game.PlaceId, LocalPlayer)
                end
            end
        end
    end)
end
